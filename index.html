<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Seguimiento de KDMs</title>
  <link rel="icon" href="https://cinepolis.com/icon.png">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #F5F5F5;
      color: #333;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    form {
      margin-top: 20px;
    }
    input[type="text"], input[type="date"] {
      margin: 5px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <img width="8%" loading="lazy" src="./logo-cinepolis-dos.webp" alt="Cin√©polis Logo">
  <h1>Seguimiento de CPL y KDM</h1>

  <input type="text" id="filtroPelicula" placeholder="üîç Filtrar por pel√≠cula..." style="width:100%; padding:5px;">
  <button onclick="logout()">Cerrar sesi√≥n</button>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Pelicula</th>
        <th>CPL recibida</th>
        <th>Fecha CPL</th>
        <th>KDM recibido</th>
        <th>KDM ingestado</th>
        <th>KDM abre</th>
        <th>KDM cierra</th>
        <th>Formatos y versiones</th>
        <th>Distribuidor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <form id="formKDM">
    <input type="text" name="Pelicula" placeholder="Pelicula" required />
    <label><input type="checkbox" name="CPL recibida" /> CPL recibida</label>
    <input type="date" name="Fecha de cpl recibida" />
    <label><input type="checkbox" name="KDM recibido" /> KDM recibido</label>
    <label><input type="checkbox" name="KDM ingestado" /> KDM ingestado</label>
    <p>KDM Abre</p><input type="date" name="KDM abre" />
    <p>KDM Cierra</p><input type="date" name="KDM cierra" />
    <input type="text" name="Formatos y versiones" placeholder="Formatos y versiones EN LAS 2D 3D" />
    <input type="text" name="Distribuidor" placeholder="Distribuidor" />
    <button type="submit">Agregar registro</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabase = window.supabase.createClient(
        'https://loeuwyskdvvxjgxjerah.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvZXV3eXNrZHZ2eGpneGplcmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNTUwNDMsImV4cCI6MjA3MDYzMTA0M30.mZmOSQv8sfFeXRdVc9ru01-C8WLlRMp6e2dhf_6Imbw'
      );

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login.html';
        return;
      }

      const { data: { user } } = await supabase.auth.getUser();

      async function cargarRegistros() {
            const { data, error } = await supabase
  .from('kdms')
  .select('*')
  .order('KDM abre', { ascending: false }) // Aseg√∫rate de tener esta columna
  .limit(50);

        if (error) {
          console.error('Error al cargar registros:', error.message);
          return;
        }

        const filtro = document.getElementById('filtroPelicula').value.toLowerCase();
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        data
          .filter(r => r['Pelicula']?.toLowerCase().includes(filtro))
          .forEach(registro => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
              <td>${registro['Pelicula'] || ''}</td>
              <td>${registro['CPL recibida'] ? '‚úÖ' : '‚ùå'}</td>
              <td>${registro['Fecha de cpl recibida'] || ''}</td>
              <td>${registro['KDM recibido'] ? '‚úÖ' : '‚ùå'}</td>
              <td>${registro['KDM ingestado'] ? '‚úÖ' : '‚ùå'}</td>
              <td>${registro['KDM abre'] || ''}</td>
              <td>${registro['KDM cierra'] || ''}</td>
              <td>${registro['Formatos y versiones'] || ''}</td>
              <td>${registro['Distribuidor'] || ''}</td>
            `;
            tbody.appendChild(fila);
          });
      }

      document.getElementById('formKDM').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        const nuevoRegistro = {
          Pelicula: form['Pelicula'].value,
          'CPL recibida': form['CPL recibida'].checked,
          'Fecha de cpl recibida': form['Fecha de cpl recibida'].value,
          'KDM recibido': form['KDM recibido'].checked,
          'KDM ingestado': form['KDM ingestado'].checked,
          'KDM abre': form['KDM abre'].value,
          'KDM cierra': form['KDM cierra'].value,
          'Formatos y versiones': form['Formatos y versiones'].value,
          Distribuidor: form['Distribuidor'].value,
          user_id: user.id
        };

        const { error } = await supabase
          .from('kdms')
          .insert([nuevoRegistro]);

        if (error) {
          console.error('Error al insertar registro:', error.message);
          alert('Hubo un error al guardar el registro');
        } else {
          alert('Registro agregado correctamente');
          form.reset();
          cargarRegistros();
        }
      });

      document.getElementById('filtroPelicula').addEventListener('input', cargarRegistros);
      cargarRegistros();
    });

    async function logout() {
      const supabase = window.supabase.createClient(
        'https://loeuwyskdvvxjgxjerah.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvZXV3eXNrZHZ2eGpneGplcmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNTUwNDMsImV4cCI6MjA3MDYzMTA0M30.mZmOSQv8sfFeXRdVc9ru01-C8WLlRMp6e2dhf_6Imbw'
      );
      await supabase.auth.signOut();
      window.location.href = '/login.html';
    }
  </script>
</body>
</html>
