<!DOCTYPE html>
<html lang="es">
<head>
  <!--Generar pdf-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>




  <meta charset="UTF-8">
  <title>Seguimiento de KDMs</title>
  <link rel="icon" href="https://cinepolis.com/icon.png">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #F5F5F5;
      color: #333;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    form {
      margin-top: 20px;
    }
    input[type="text"], input[type="date"] {
      margin: 5px;
      padding: 5px;
    }
  </style>
</head>
<body>
  <img width="8%" loading="lazy" src="./logo-cinepolis-dos.webp" alt="Cin√©polis Logo">
  <h1>Seguimiento de CPL y KDM</h1>

  <input type="text" id="filtroPelicula" placeholder="üîç Filtrar por pel√≠cula..." style="width:100%; padding:5px;">
  <button onclick="logout()">Cerrar sesi√≥n</button>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Pelicula</th>
        <th>CPL recibida</th>
        <th>Fecha CPL</th>
        <th>KDM recibido</th>
        <th>KDM ingestado</th>
        <th>KDM abre</th>
        <th>KDM cierra</th>
        <th>Formatos y versiones</th>
        <th>Distribuidor</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <section id="New_entry">
<h1>Agregar nuevos registros</h1>
  <form id="formKDM">
    <p>Titulo (tal cual como esta pautado, si ya existen registros de esa pelicula usar el mismo titulo)</p><input type="text" name="Pelicula" placeholder="Pelicula" required />
    <p></p><label><input type="checkbox" name="CPL recibida" /> CPL recibida</label>
    <input type="date" name="Fecha de cpl recibida" />
    <p></p><label><input type="checkbox" name="KDM recibido" /> KDM recibido</label>
    <label><input type="checkbox" name="KDM ingestado" /> KDM ingestado</label>
    <p>KDM Abre</p><input type="date" name="KDM abre" />
    <p>KDM Cierra</p><input type="date" name="KDM cierra" />
    <p>Formatos y versiones, colocar primero las versiones (EN LAS) y despues los formatos (2D 3D)</p><input type="text" name="Formatos y versiones" placeholder="Formatos y versiones EN LAS 2D 3D" />
    
    <select id="distribuidor" name="distribuidor" required>
  <option value="">Selecciona distribuidor</option>
  <option value="Walt Disney Pictures">Walt Disney Pictures</option>
  <option value="Videocine">Videocine</option>
  <option value="Warner Bros">Warner Bros</option>
  <option value="Sony Pictures">Sony Pictures</option>
  <option value="Universal Pictures">Universal Pictures</option>
  <option value="Coraz√≥n Films">Coraz√≥n Films</option>
  <option value="Imagem Films">Imagem Films</option>
  <option value="Diamond Films M√©xico">Diamond Films M√©xico</option>
  <option value="Gussi Cinema">Gussi Cinema</option>
  <option value="Cin√©polis Distribuci√≥n">Cin√©polis Distribuci√≥n</option>
  <option value="+QUE CINE">+QUE CINE</option>
</select>

    <button type="submit">Agregar registro</button>
  </form>
  </section>
  <section id="Generate_report">
    <h1>Generar reporte para gerente</h1>
    <button id="generar-pdf">üìÑ Generar reporte PDF</button>

  </section>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const supabase = window.supabase.createClient(
        'https://loeuwyskdvvxjgxjerah.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvZXV3eXNrZHZ2eGpneGplcmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNTUwNDMsImV4cCI6MjA3MDYzMTA0M30.mZmOSQv8sfFeXRdVc9ru01-C8WLlRMp6e2dhf_6Imbw'
      );

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login.html';
        return;
      }

      const { data: { user } } = await supabase.auth.getUser();

      async function cargarRegistros() {
            const { data, error } = await supabase
  .from('kdms')
  .select('*')
  .order('KDM abre', { ascending: false }) // Aseg√∫rate de tener esta columna
  .limit(50);

        if (error) {
          console.error('Error al cargar registros:', error.message);
          return;
        }

        const filtro = document.getElementById('filtroPelicula').value.toLowerCase();
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        data
          .filter(r => r['Pelicula']?.toLowerCase().includes(filtro))
          .forEach(registro => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
              <td>${registro['Pelicula'] || ''}</td>
              <td>${registro['CPL recibida'] ? '‚úÖ' : '‚ùå'}</td>
              <td>${registro['Fecha de cpl recibida'] || ''}</td>
              <td>${registro['KDM recibido'] ? '‚úÖ' : '‚ùå'}</td>
              <td>${registro['KDM ingestado'] ? '‚úÖ' : '‚ùå'}</td>
              <td>${registro['KDM abre'] || ''}</td>
              <td>${registro['KDM cierra'] || ''}</td>
              <td>${registro['Formatos y versiones'] || ''}</td>
              <td>${registro['Distribuidor'] || ''}</td>
            `;
            tbody.appendChild(fila);
          });
      }

      document.getElementById('formKDM').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;

        const nuevoRegistro = {
          Pelicula: form['Pelicula'].value,
          'CPL recibida': form['CPL recibida'].checked,
          'Fecha de cpl recibida': form['Fecha de cpl recibida'].value,
          'KDM recibido': form['KDM recibido'].checked,
          'KDM ingestado': form['KDM ingestado'].checked,
          'KDM abre': form['KDM abre'].value,
          'KDM cierra': form['KDM cierra'].value,
          'Formatos y versiones': form['Formatos y versiones'].value,
          Distribuidor: form['Distribuidor'].value,
          user_id: user.id
        };

        const { error } = await supabase
          .from('kdms')
          .insert([nuevoRegistro]);

        if (error) {
          console.error('Error al insertar registro:', error.message);
          alert('Hubo un error al guardar el registro');
        } else {
          alert('Registro agregado correctamente');
          form.reset();
          cargarRegistros();
        }
      });

      document.getElementById('filtroPelicula').addEventListener('input', cargarRegistros);
      cargarRegistros();

      document.getElementById('generar-pdf').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const { data, error } = await supabase
    .from('kdms')
    .select('*')
    .order('KDM abre', { ascending: false });

  if (error) {
    alert('Error al obtener datos');
    return;
  }

  let y = 10;
  doc.setFontSize(12);
  doc.text('Reporte de KDMs', 10, y);
  y += 10;

  data.forEach((r, i) => {
    doc.text(`Pel√≠cula: ${r['Pelicula'] || ''}`, 10, y); y += 6;
    doc.text(`CPL recibida: ${r['CPL recibida'] ? 'S√≠' : 'No'}`, 10, y); y += 6;
    doc.text(`Fecha CPL: ${r['Fecha de cpl recibida'] || ''}`, 10, y); y += 6;
    doc.text(`KDM recibido: ${r['KDM recibido'] ? 'S√≠' : 'No'}`, 10, y); y += 6;
    doc.text(`KDM ingestado: ${r['KDM ingestado'] ? 'S√≠' : 'No'}`, 10, y); y += 6;
    doc.text(`KDM abre: ${r['KDM abre'] || ''}`, 10, y); y += 6;
    doc.text(`KDM cierra: ${r['KDM cierra'] || ''}`, 10, y); y += 6;
    doc.text(`Formatos: ${r['Formatos y versiones'] || ''}`, 10, y); y += 6;
    doc.text(`Distribuidor: ${r['Distribuidor'] || ''}`, 10, y); y += 10;

    if (y > 270) { doc.addPage(); y = 10; }
  });

  doc.save('reporte_kdms.pdf');
});


    });

    async function logout() {
      const supabase = window.supabase.createClient(
        'https://loeuwyskdvvxjgxjerah.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvZXV3eXNrZHZ2eGpneGplcmFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNTUwNDMsImV4cCI6MjA3MDYzMTA0M30.mZmOSQv8sfFeXRdVc9ru01-C8WLlRMp6e2dhf_6Imbw'
      );
      await supabase.auth.signOut();
      window.location.href = '/login.html';
    }
  </script>
</body>
</html>
